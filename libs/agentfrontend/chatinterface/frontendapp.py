import streamlit as st

import os.path as osp
import sys

import random

from pydantic import BaseModel
from typing import Optional

script_dir = osp.dirname(__file__)
sys.path.insert(0, osp.dirname(script_dir))
from _ui.generaloptions import change_button_style, detect_browser, change_button_style_image


def shuffle_tuple(tup, fixed_elements=3, prob=0.40):
    """Return a new tuple with elements shuffled, except for one element."""
    if len(tup) <= fixed_elements:
        return tup
    
    lst = list(tup)  # 
    if random.random() < prob:  # probability to swap
        index = random.randint(0, fixed_elements - 1)  # Select a random index from first (n) elements
        swap = random.randint(fixed_elements, len(lst) - 1)  # Select a random index to swap 
        lst[index] = lst[swap]  # Swap the selected element with the last element
    return tuple(lst[:fixed_elements])  # Convert list back to tuple


class ChatBotApp(BaseModel):
    title: str = 'My First LLM Chat'
    description: Optional[str]= None
    caption: str = 'Responses are generated by AI and may be inaccurate or inappropriate.'
    buttons: tuple = (
        ('Button 1', 'This is my short instruction content, with multiline instruction', None),
        ('Button 2', 'This is my short instruction content, with multiline instruction', None),
        ('Button 3', 'This is my short instruction content, with multiline instruction', None),
    )
    buttontype: str = 'text'

    def _apppagedefault(self, title="Claim AI", icon="ðŸ¦œ"):
        st.set_page_config(
            page_title = title,
            page_icon = icon
        )

        with st.sidebar:
            st.title('ðŸ¦œ Claim AI')
            st.write("â›¶  New Conversation")

    def _render(self):
        "Renders the chatbot UI"
        st.title(self.title)
        st.caption(self.caption)
        st.write(self.description)

        styling = change_button_style if self.buttontype == 'text' else change_button_style_image
        
        button_topn = shuffle_tuple(self.buttons)
        cols = st.columns(len(button_topn))

        for i, entry in enumerate(button_topn):   
            title, render_object, action = entry
            cols[i].button(title, key=f"button_{i}", on_click=action)
            styling(title, title, render_object)

        prompt = st.chat_input("How can I help?")
        if prompt:
            with st.chat_message("user"):
                st.write(f"User has sent the following prompt: {prompt}")
            with st.chat_message("assistant"):
                st.write("Hello ðŸ‘‹, I am the Assistant")

    @staticmethod
    def _zcheck():
        "Static Method to check browser"
        with st.container():
            detect_browser()
        
    def __call__(self, debug:str = False):
        if debug:
            self._render
            self._zcheck
        else:
            self._apppagedefault()
            self._render()
            self._zcheck()


if __name__=="__main__":
    ui = ChatBotApp(
        title='Claims AI-Assistant',
        description= """
        Description: An AI-Powered Claims Assistant designed to help adjusters in contact centers quickly and effectively
        respond to customers needs within a single application.
        """,
        buttons=(
            ('Doc Intelligence', 'https://images.pexels.com/photos/1109541/pexels-photo-1109541.jpeg', None),
            ('Summarize', 'https://images.pexels.com/photos/699122/pexels-photo-699122.jpeg', None),
            ('VIN Decoding', 'https://www.shutterstock.com/image-vector/magnifying-glass-car-selling-icon-600nw-431692936.jpg', None),
            ('Claim-oween', 'https://images.pexels.com/photos/3095465/pexels-photo-3095465.png', None),
        ),
        buttontype='image'
    )
    ui(False)
    